<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kazan's Quick Share Protocol (KQSP)</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2em auto; }
    input, button { font-size: 1em; margin: .5em 0; width: 100%; box-sizing: border-box; }
    #messages { border: 1px solid #ccc; padding: 1em; height: 200px; overflow-y: auto; }
    #kaddr { font-size: 0.9em; color: #333; }
    #file-input { padding: .2em; }
  </style>
</head>
<body>
  <h1>Kazan's Quick Share Protocol</h1>
  <p>Your Address: <strong id="kaddr">connecting…</strong></p>

  <label>Group Peers (comma-sep K(...) IDs):</label>
  <input type="text" id="peer-input" placeholder="e.g. K(id1), K(id2), K(id3)">
  <button id="connect-btn">Connect to Group</button>

  <label>Message:</label>
  <input type="text" id="msg-input" placeholder="Type a message…">
  <button id="send-btn" disabled>Send Message</button>

  <label>File:</label>
  <input type="file" id="file-input">
  <button id="send-file-btn" disabled>Send Encrypted File</button>

  <h2>Messages</h2>
  <div id="messages"></div>

  <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
  <script>
    const peer = new Peer();
    const conns = [];             // all DataConnections
    let groupKeyBytes = null;     // Uint8Array of shared KEA key

    // Display our address
    peer.on('open', id => {
      document.getElementById('kaddr').textContent = 'K(' + id + ')';
      updateGroupKey();
    });

    // Incoming connections
    peer.on('connection', incoming => {
      conns.push(incoming);
      incoming.on('open', () => {
        alert('User joined group: ' + incoming.peer);
        setupConnection(incoming);
        updateGroupKey();
        updateButtons();
      });
    });

    // Connect to a comma-separated list of peers
    document.getElementById('connect-btn').onclick = () => {
      const raw = document.getElementById('peer-input').value;
      const ids = raw.split(',')
        .map(s => s.trim().replace(/^K\(|\)$/g, ''))
        .filter(s => s);
      if (!ids.length) return alert('Enter at least one K(...) address');
      ids.forEach(pid => {
        const c = peer.connect(pid);
        conns.push(c);
        c.on('open', () => {
          alert('Connected to: ' + pid);
          setupConnection(c);
          updateGroupKey();
          updateButtons();
        });
        c.on('error', e => alert('Connection error: ' + e));
      });
    };

    // Enable/disable Send buttons
    function updateButtons() {
      const ok = conns.some(c => c.open);
      document.getElementById('send-btn').disabled = !ok;
      document.getElementById('send-file-btn').disabled = !ok;
    }

    // Compute a shared KEA key: SHA-256 over sorted [selfID, ...peerIDs]
    async function updateGroupKey() {
      const ids = Array.from(new Set([
        peer.id,
        ...conns.filter(c => c.open).map(c => c.peer)
      ])).sort();
      const buf = await crypto.subtle.digest(
        'SHA-256',
        new TextEncoder().encode(JSON.stringify(ids))
      );
      groupKeyBytes = new Uint8Array(buf);
    }

    // Common setup for each connection
    function setupConnection(c) {
      c.on('data', async data => {
        if (data.type === 'text') {
          // decrypt text
          const enc = new TextEncoder().encode(data.text);
          const decBytes = enc.map((b,i)=> b ^ groupKeyBytes[i % groupKeyBytes.length]);
          const text = new TextDecoder().decode(decBytes);
          appendMessage(`${data.from}: ${text}`);
        }
        else if (data.type === 'file') {
          alert(`File received from ${data.from}: ${data.filename}`);
          // decrypt file
          const enc = new Uint8Array(data.data);
          const dec = enc.map((b,i)=> b ^ groupKeyBytes[i % groupKeyBytes.length]);
          const blob = new Blob([dec], { type: 'application/octet-stream' });
          const a = document.createElement('a');
          a.download = data.filename;
          a.href = URL.createObjectURL(blob);
          a.textContent = `Download ${data.filename}`;
          document.getElementById('messages').appendChild(a);
          document.getElementById('messages').appendChild(document.createElement('br'));
        }
      });
      c.on('close', () => {
        alert('A peer has left the group: ' + c.peer);
        updateGroupKey();
        updateButtons();
      });
    }

    function appendMessage(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      document.getElementById('messages').appendChild(div);
    }

    // Send an encrypted chat message
    document.getElementById('send-btn').onclick = () => {
      const text = document.getElementById('msg-input').value;
      if (!text) return;
      // encrypt text
      const plain = new TextEncoder().encode(text);
      const encBytes = plain.map((b,i) => b ^ groupKeyBytes[i % groupKeyBytes.length]);
      const encText = Array.from(encBytes).map(b=>String.fromCharCode(b)).join('');
      const payload = {
        type: 'text',
        from: document.getElementById('kaddr').textContent,
        text: encText
      };
      conns.filter(c=>c.open).forEach(c=>c.send(payload));
      appendMessage('You: ' + text);
      document.getElementById('msg-input').value = '';
    };

    // Send an encrypted file
    document.getElementById('send-file-btn').onclick = () => {
      const file = document.getElementById('file-input').files[0];
      if (!file) return alert('Select a file');
      const reader = new FileReader();
      reader.onload = async () => {
        const data = new Uint8Array(reader.result);
        const enc = data.map((b,i)=> b ^ groupKeyBytes[i % groupKeyBytes.length]);
        const payload = {
          type: 'file',
          from: document.getElementById('kaddr').textContent,
          filename: file.name,
          data: enc.buffer
        };
        conns.filter(c=>c.open).forEach(c=>c.send(payload));
        alert('Encrypted file sent: ' + file.name);
      };
      reader.readAsArrayBuffer(file);
    };
  </script>
</body>
</html>
