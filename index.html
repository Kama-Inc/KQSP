<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kazan's Quick Share Protocol (KQSP)</title>
  <style>
    :root {
      --bg: #f5f5f5;
      --fg: #222;
      --input-bg: #fff;
      --input-fg: #222;
      --border: #ccc;
      --accent: #0066cc;
    }
    .dark-mode {
      --bg: #222;
      --fg: #f5f5f5;
      --input-bg: #333;
      --input-fg: #f5f5f5;
      --border: #555;
      --accent: #66aaff;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: sans-serif;
      max-width: 600px;
      margin: 2em auto;
      transition: background 0.3s, color 0.3s;
    }
    header { display: flex; justify-content: space-between; align-items: center; }
    h1 { margin: 0; font-size: 1.5em; }
    button, input {
      font-size: 1em;
      margin: 0.5em 0;
      padding: 0.5em;
      width: 100%;
      background: var(--input-bg);
      color: var(--input-fg);
      border: 1px solid var(--border);
      border-radius: 4px;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #messages {
      border: 1px solid var(--border);
      padding: 1em;
      height: 200px;
      overflow-y: auto;
      background: var(--input-bg);
    }
    #kaddr { font-size: 0.9em; color: var(--accent); word-break: break-all; }
    .row { display: flex; gap: 0.5em; }
    .row > * { flex: 1; }
  </style>
</head>
<body>
  <header>
    <h1>KQSP</h1>
    <button id="theme-toggle">🌙</button>
  </header>

  <p>Your Address: <strong id="kaddr">generating…</strong></p>

  <label>Group Peers (comma-sep K(...) IDs):</label>
  <input type="text" id="peer-input" placeholder="e.g. K(500.1.2.3), K(44.55.66.77)">

  <button id="connect-btn">Connect to Group</button>

  <label>Message:</label>
  <div class="row">
    <input type="text" id="msg-input" placeholder="Type a message…">
    <button id="send-btn" disabled>Send</button>
  </div>

  <label>File (optional password):</label>
  <input type="file" id="file-input">
  <input type="password" id="file-password" placeholder="File password (optional)">
  <button id="send-file-btn" disabled>Send File</button>

  <h2>Messages</h2>
  <div id="messages"></div>

  <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
  <script>
    // --- Dark Mode Toggle ---
    const themeBtn = document.getElementById('theme-toggle');
    const body = document.body;
    let dark = false;
    themeBtn.onclick = () => {
      dark = !dark;
      body.classList.toggle('dark-mode', dark);
      themeBtn.textContent = dark ? '☀️' : '🌙';
    };

    // --- Generate numeric ID before PeerJS init ---
    function randomOctet() { return Math.floor(Math.random() * 256); }
    const localId = `${randomOctet()}.${randomOctet()}.${randomOctet()}.${randomOctet()}`;
    document.getElementById('kaddr').textContent = 'K(' + localId + ')';

    // --- PeerJS Setup with custom numeric ID ---
    const peer = new Peer(localId);
    const conns = [];
    let groupKeyBytes = null;

    peer.on('open', id => {
      // id === localId
      updateGroupKey();
    });

    peer.on('error', err => {
      alert('PeerJS error: ' + err);
    });

    peer.on('connection', conn => {
      conns.push(conn);
      conn.on('open', () => {
        alert('User joined: ' + conn.peer);
        setupConnection(conn);
        updateGroupKey();
        updateButtons();
      });
    });

    document.getElementById('connect-btn').onclick = () => {
      const raws = document.getElementById('peer-input').value;
      const ids = raws.split(',')
        .map(s => s.trim().replace(/^K\(|\)$/g, ''))
        .filter(Boolean);
      if (!ids.length) return alert('Enter at least one K(...)');
      ids.forEach(pid => {
        const c = peer.connect(pid);
        conns.push(c);
        c.on('open', () => {
          alert('Connected to: ' + pid);
          setupConnection(c);
          updateGroupKey();
          updateButtons();
        });
        c.on('error', e => alert('Connection error: ' + e));
      });
    };

    function updateButtons() {
      const ok = conns.some(c => c.open);
      document.getElementById('send-btn').disabled = !ok;
      document.getElementById('send-file-btn').disabled = !ok;
    }

    async function updateGroupKey() {
      if (!peer.id) return;
      const ids = Array.from(new Set(
        [peer.id, ...conns.filter(c=>c.open).map(c=>c.peer)]
      )).sort();
      const buf = await crypto.subtle.digest(
        'SHA-256',
        new TextEncoder().encode(JSON.stringify(ids))
      );
      groupKeyBytes = new Uint8Array(buf);
    }

    function setupConnection(c) {
      c.on('data', data => {
        if (data.type === 'text') {
          const enc = Uint8Array.from(data.text.split('').map(ch => ch.charCodeAt(0)));
          const dec = enc.map((b,i)=> b ^ groupKeyBytes[i % groupKeyBytes.length]);
          append(`${data.from}: ${new TextDecoder().decode(dec)}`);
        }
        else if (data.type === 'file') {
          alert(`File from ${data.from}: ${data.filename}`);
          const keyBytes = new Uint8Array(data.key);
          const enc = new Uint8Array(data.data);
          const dec = enc.map((b,i)=> b ^ keyBytes[i % keyBytes.length]);
          const blob = new Blob([dec], { type: 'application/octet-stream' });
          const a = document.createElement('a');
          a.download = data.filename;
          a.href = URL.createObjectURL(blob);
          a.textContent = `Download ${data.filename}`;
          const msg = document.getElementById('messages');
          msg.appendChild(a);
          msg.appendChild(document.createElement('br'));
        }
      });
      c.on('close', () => {
        alert('Peer left: ' + c.peer);
        updateGroupKey();
        updateButtons();
      });
    }

    function append(text) {
      const div = document.createElement('div');
      div.textContent = text;
      document.getElementById('messages').appendChild(div);
    }

    // --- Send Encrypted Text ---
    document.getElementById('send-btn').onclick = () => {
      const txt = document.getElementById('msg-input').value;
      if (!txt) return;
      const enc = new TextEncoder().encode(txt)
        .map((b,i)=> b ^ groupKeyBytes[i % groupKeyBytes.length]);
      const payload = {
        type: 'text',
        from: document.getElementById('kaddr').textContent,
        text: String.fromCharCode(...enc)
      };
      conns.filter(c=>c.open).forEach(c=>c.send(payload));
      append('You: ' + txt);
      document.getElementById('msg-input').value = '';
    };

    // --- Send Encrypted File with Optional Password ---
    document.getElementById('send-file-btn').onclick = async () => {
      const file = document.getElementById('file-input').files[0];
      if (!file) return alert('Select a file');
      const pwd = document.getElementById('file-password').value;
      let keyBytes = groupKeyBytes;
      if (pwd) {
        const buf = await crypto.subtle.digest(
          'SHA-256',
          new TextEncoder().encode(pwd)
        );
        keyBytes = new Uint8Array(buf);
      }
      const reader = new FileReader();
      reader.onload = () => {
        const data = new Uint8Array(reader.result);
        const enc = data.map((b,i)=> b ^ keyBytes[i % keyBytes.length]);
        const payload = {
          type: 'file',
          from: document.getElementById('kaddr').textContent,
          filename: file.name,
          key: Array.from(keyBytes),
          data: enc.buffer
        };
        conns.filter(c=>c.open).forEach(c=>c.send(payload));
        alert('Encrypted file sent: ' + file.name);
      };
      reader.readAsArrayBuffer(file);
    };
  </script>
</body>
</html>
